name: Weekly Dev to Main PR

on:
  schedule:
    # Runs every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch branches
        run: |
          git fetch origin main
          git fetch origin dev

      - name: Close previous auto-generated PRs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find open PRs from dev to main with our specific title
          gh pr list \
            --base main \
            --head dev \
            --state open \
            --search "Weekly: Merge dev into main in:title" \
            --json number \
            --jq '.[].number' | while read pr_number; do
              if [ -n "$pr_number" ]; then
                echo "Closing PR #$pr_number"
                gh pr close "$pr_number" --comment "Closing to create a new weekly PR"
              fi
            done

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if dev and main are different
          if ! git diff --quiet origin/main...origin/dev; then
            gh pr create \
              --base main \
              --head dev \
              --title "Weekly: Merge dev into main" \
              --body "This is an automated weekly PR to merge changes from \`dev\` into \`main\`.

          Please review the changes and merge when ready.

          ---
          *This PR was automatically created by GitHub Actions*" || echo "PR might already exist"
          else
            echo "No changes between dev and main, skipping PR creation"
          fi
